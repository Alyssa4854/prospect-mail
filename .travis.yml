sudo: required
dist: xenial
services: docker
language: minimal
before_install:
  - sudo snap install node --channel 12/stable --classic
cache:
  directories:
  - node_modules
  - "$HOME/.cache/electron"
  - "$HOME/.cache/electron-builder"
script: |
  docker run --rm \
    --env-file <(env | grep -v '\r' | grep -iE 'DEBUG|NODE_|ELECTRON_|YARN_|NPM_|CI|CIRCLE|TRAVIS|APPVEYOR_|CSC_|_TOKEN|_KEY|AWS_|STRIP|BUILD_') \
    -v ${PWD}:/project \
    -v ~/.cache/electron:/root/.cache/electron \
    -v ~/.cache/electron-builder:/root/.cache/electron-builder \
    node/12 \
    /bin/bash -c "yarn --link-duplicates --pure-lockfile && yarn release"
deploy:
  - provider: snap
    snap: dist/prospect-mail*.snap
    channel: edge
    skip_cleanup: true
    on:
      branch: develop
  - provider: snap
    snap: dist/prospect-mail*.snap
    channel: stable
    skip_cleanup: true
    on:
      branch: master
branches:
  except:
  - "/^v\\d+\\.\\d+\\.\\d+$/"
